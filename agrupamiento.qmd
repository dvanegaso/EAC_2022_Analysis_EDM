---
title: "Agrupamiento"
format: html
editor: visual
theme: lux
echo: false
---
```{r}

suppressMessages({
  # cambia idioma de la consola de R a español:
  Sys.setenv(LANG="es")
  
  #Sin notacion cientifica y con 3 decimales
  options(digits = 3, scipen = 999) 
  
  #Importamos Librerias
  library(readxl)
  library(FactoClass)
  library(factoextra)
  library(plotly)
  library(knitr)
  library(ggplot2)
  library(dplyr)
  library(Factoshiny)
  library(DT) # para tablas interactivas
  library(plotly) # para gráficos interactivos
  
  #Importamos la base de datos
  setwd("C:/Users/thetr/OneDrive/Documentos/R/Proyecto EDM")
  ruta_del_archivo <- "EAC_CIFRAS_2022_ANONIMIZADA_FINAL.csv"
  datos_orig <- read.csv(ruta_del_archivo, sep = ";", dec = ",")
  
  #En nuestro estudio, tomaremos aquellas empresas Activas. POr lo que, no tomaremos encienta a empresas con produccion bruta = 0. 
  #Asi que, eliminaremos aquellos datos que tengan produccion bruta =0 (Son alrededor de 200 datos).
  datos <- datos_orig[!is.na(as.numeric(datos_orig$BRUTA)) & as.numeric(datos_orig$BRUTA) != 0, ]
  
#Crearemos dos nuevas bases de datos, en este caso, para las variables discretas y continuas de nuestro interes.
#IDOJ1
discretas <- select(datos, CORRELA_16, IDAIO, PROMUJ, PROHOM, PERMUJ, PERHOM, DIRMUJ, DIRHOM, AGENCIA, APRENDIZ, PUBLICI, SOCIOS, PERSONOM, DIRECTO, TOTMUJ, TOTHOM)
continuas <- select(datos, BRUTA, CONSUI, SUELDOS, PRESTAC, VENTA, AGREGA, SUEPLAN, PREPLAN, COTIZA, TOTREM, ROTACION, INVPRO, CTO, CTOINS, GASTOS, GASTOSNOP)
                                                                    
# convertimos los datos a tipo numerico. 
continuas <- data.frame(lapply(continuas, function(x) as.numeric(as.character(x))))
# convertimos a sus respectivos valores en pesos colombianos
continuas <-1000*continuas

#Ahora agregamos nuevas variables a continuas
Clasifemp <-discretas$CORRELA_16
continuas <- cbind(Clasifemp, continuas)

#asignamos a los NA el valor de cero
continuas[is.na(continuas)] <- 0 

# Ahora, clasificamos los datos de tipo discret

#Años empresa
años <- as.integer(discretas$IDAIO)
años[años < 1972] <- 1
años[años >= 1972 & años < 1982] <- 2
años[años >= 1982 & años < 1992] <- 3
años[años >= 1992 & años < 2002] <- 4
años[años >= 2002 & años < 2012] <- 5
años[años >= 2012 & años < 2024] <- 6

años <- factor(años, labels=c( "Mas de 50","Entre 40 y 50", "Entre 30 y 40", "Entre 30 y 20", "Entre 20 y 10", "Menos de 10"))
discretas$IDAIO <- años
#personal permanete
permanente <- as.integer(discretas$PERSONOM)
permanente [permanente >= 1 & permanente < 10 ] <- 1
permanente [permanente >= 10 ] <- 2
permanente <- factor(permanente, labels=c("(0)PERM", "(1-10)PERM", "(>10)PERM"))
discretas$PERSONOM <- permanente 

# Personal DIRECTO
directo <- as.integer(discretas$DIRECTO)
directo[directo >= 1 & directo<= 10 ] <- 1
directo[directo  > 10 ] <- 2
directo <- factor(directo, labels=c("(0)DIREC", "(1-10)DIREC", "(>10)DIREC"))
discretas$DIRECTO <- directo

#Total hombres
thombres <- as.integer(discretas$TOTHOM)
thombres[is.na(thombres)] <- 0 #Asignarle el valor de cero a los nas
thombres[thombres >= 1 & thombres<= 10 ] <- 1
thombres[thombres  > 10 ] <- 2
thombres <- factor(thombres, labels=c("(0)HOMBRES", "(1-10)HOMBRES", "(>10)HOMBRES"))
discretas$TOTHOM <- thombres


#Total Mujeres
tmujeres <- as.integer(discretas$TOTMUJ)
tmujeres[is.na(tmujeres)] <- 0 #Asignarle el valor de cero a los nas
tmujeres[tmujeres >= 1 & tmujeres < 10 ] <- 1
tmujeres[tmujeres >= 10 ] <- 2
tmujeres <- factor(tmujeres, labels=c("(0)MUJERES", "(1-10)MUJERES", "(>10)MUJERES"))
discretas$TOTMUJ <- tmujeres

# numero de socios
n_socios <- as.numeric(datos$SOCIOS)
n_socios[n_socios == 0 ] <- 0 #Asignarle el valor de cero a los nas
n_socios[n_socios > 0 & n_socios < 4] <- 1
n_socios[n_socios >= 4 & n_socios<100] <- 2
n_socios <- factor(n_socios, labels=c("No Registra","Pocos Socios", "Bastantes Socios"))
discretas$SOCIOS <- n_socios

#clasificamos las empresas segun su tamañó. Es este caso, basaremos la clasificaion "Decreto 957 de 2019".
pbruta <- 1000*as.numeric(datos$BRUTA)
#precio uvt añó 2022
uvt22 = 38004
TMÑEMP <- unlist(pbruta/uvt22)
TMÑEMP[TMÑEMP <= 44769 ] <- 1
TMÑEMP[TMÑEMP > 44769 & TMÑEMP <= 431196] <- 2
TMÑEMP[TMÑEMP > 431196 & TMÑEMP <= 2160692] <- 3
TMÑEMP[TMÑEMP > 2160692] <- 4
TMÑEMP <- factor(TMÑEMP, labels=c("MIcroe", "PQempr", "MEdempr", "EmprGran"))
discretas <- cbind(discretas, TMÑEMP)

#Clasificamos publicidad, basandonos en el porcentaje gastado respecto a la produccion bruta.
pbruta <- abs(pbruta/1000)
publicidad <- as.numeric(discretas$PUBLICI)
contador = as.integer(1)

for(i in publicidad){
  if (i/pbruta[contador] > 0 & i/pbruta[contador] <= 0.05){
    publicidad[contador] <- 1 
  }else if (i/pbruta[contador] > 0.05 & i/pbruta[contador] <= 0.1) {
    publicidad[contador] <- 2 
  }else if (i/pbruta[contador] > 0.1) {
    publicidad[contador] <- 3
  }
  contador <- contador+1
  
}

publicidad <- factor(publicidad, labels=c("Nopub", "Pubbaja", "Pubmod", "Pubalta"))
discretas$PUBLICI <- publicidad

#OTRAS POSIBLES CLASIFICACIONES


# #Socios Mujeres
smujeres <- as.integer(discretas$PROMUJ)
smujeres[smujeres >= 1 ] <- 1
smujeres <- factor(smujeres, labels=c("SisociosM", "NosociosM"))
discretas$PROMUJ<- smujeres
# 
#Socios Hombres
shombres <- as.integer(discretas$PROHOM)
shombres[shombres >= 1 ] <- 1
shombres <- factor(shombres, labels=c("SisociosH", "NosociosH"))
discretas$PROHOM<- shombres

#personal permanete mujeres
pmujeres <- as.integer(discretas$PERMUJ)
pmujeres[pmujeres >= 1 & pmujeres < 10 ] <- 1
pmujeres[pmujeres >= 10 ] <- 2
pmujeres <- factor(pmujeres, labels=c("(0)PerM", "(1-10)PerM", "(>10)PerM"))
discretas$PERMUJ <- pmujeres

# Personal permanente Hombres
phombres <- as.integer(discretas$PERHOM)
phombres[phombres >= 1 & phombres<= 10 ] <- 1
phombres[phombres  > 10 ] <- 2
phombres <- factor(phombres, labels=c("(0)PerH", "(1-10)PerH", "(>10)PerH"))
discretas$PERHOM <- phombres
# 
# Personal Temporal Mujeres
tmujeres <- as.integer(discretas$DIRMUJ)
tmujeres[tmujeres >= 1 & tmujeres < 10 ] <- 1
tmujeres[tmujeres >= 10 ] <- 2
tmujeres <- factor(tmujeres, labels=c("(0)tempM", "(1-10)tempM", "(>10)tempM"))
discretas$DIRMUJ <- tmujeres

# Personal Temporal Hombres
thombres <- as.integer(discretas$DIRHOM)
thombres[thombres >= 1 & thombres<= 10 ] <- 1
thombres[thombres  > 10 ] <- 2
thombres <- factor(thombres, labels=c("(0)tempH", "(1-10)tempH", "(>10)tempH"))
discretas$DIRHOM <- thombres
# 
# Personal temporal cont a través de agencias
ptagenc <- as.integer(discretas$AGENCIA)
ptagenc[ptagenc >= 1 & ptagenc < 10 ] <- 1
ptagenc[ptagenc >= 10 ] <- 2
ptagenc <- factor(ptagenc, labels=c("(0)PTAgenc", "(1-10)PTAgenc", "(>10)PTAgenc"))
discretas$AGENCIA <- ptagenc
# 
# Aprendices
aprendiz <- as.integer(discretas$APRENDIZ)
aprendiz[aprendiz >= 1 & aprendiz<= 10 ] <- 1
aprendiz[aprendiz  > 10 ] <- 2
aprendiz <- factor(aprendiz, labels=c("(0)Apren", "(1-10)Apren", "(>10)Apren"))
discretas$APRENDIZ <- aprendiz





#Reclasificamos al tipo de empresas

# Tipempr <- discretas$CORRELA_16
# tipo1 <- list(454, 451, 453)
# tipo2 <- list(462, 464, 465, 466)
# tipo3 <- list("4711-472", 4719, 473, "4741-4742", 4752, "4759-4761", "4771-4751", 4772, 4773)
# 
# Tipempr[Tipempr %in% tipo1] <- 1
# Tipempr[Tipempr %in% tipo2] <- 2
# Tipempr[Tipempr %in% tipo3] <- 3
# 
# Tipempr <- factor(as.integer(Tipempr), labels=c("Comercio vehiculos", "Comercio al por mayor", "Comercio al por menor"))
# discretas$CORRELA_16 <- Tipempr
# 
# table(discretas$IDOJ1)
# K <- unclass(table(discretas$TMÑEMP, discretas$CORRELA_16))
# K_add <- addmargins(K)

#PCAshiny(continuas)
#res.PCA<-PCA(continuas,quali.sup=c(1),graph=FALSE)
#plot.PCA(res.PCA,choix='var',cex=1.2,cex.main=1.2,cex.axis=1.2 )
#plot.PCA(res.PCA,axes=c(1,3),choix='var')
#plot.PCA(res.PCA,axes=c(2,3),choix='var')
# Semilla
set.seed(13)

#Reclasificamos algunas variables para poder tener categorias uniformes
#Reclasificamos edad

años <- as.integer(datos$IDAIO)
años[años < 1992] <- 1
años[años >= 1992 & años < 2002] <- 2
años[años >= 2002 & años < 2012] <- 3
años[años >= 2012 & años < 2024] <- 4

años <- factor(años, labels=c( "Mas de 30", "Entre 30 y 20", "Entre 20 y 10", "Menos de 10"))
discretas$IDAIO <- años

#Reclasificamos al tipo de empresas

Tipempr <- discretas$CORRELA_16
tipo1 <- list(454, 451, 453)
tipo2 <- list(462, 464, 465, 466)
tipo3 <- list("4711-472", 4719, 473, "4741-4742", 4752, "4759-4761", "4771-4751", 4772, 4773)

Tipempr[Tipempr %in% tipo1] <- 1
Tipempr[Tipempr %in% tipo2] <- 2
Tipempr[Tipempr %in% tipo3] <- 3

Tipempr <- factor(as.integer(Tipempr), labels=c("Comercio vehiculos", "Comercio al por mayor", "Comercio al por menor"))
discretas$CORRELA_16 <- Tipempr
discretas[] <- lapply(discretas, as.factor)
})
```
## Introducción

Se consideraron tres clasificaciones para los datos:

1. Agrupamiento según Tamaño. (Siguiendo Criterios del Libro)
2. Agrupamiento Según Proyección.

Tambien se tomaron en cuenta las siguientes variables:

::: {.callout collapse="true"}
## Desplegar

-   Años en Activo de la Empresa
    -   Mas de 30
    -   Entre 20 y 30
    -   Entre 10 y 20
    -   Menos de 10
-   Personal Permanente
    -   Ningún permanente
    -   1 a 10 permanentes
    -   Más de 10 permanententes
-   Personal Contratado Directamente
    -   Ninguno
    -   1 a 10
    -   Más de 10
-   Personal Aprendiz
    -   Ninguno
    -   1 a 10 aprendices
    -   Más de 10 aprendices
-   Total hombres
    -   Ninguno
    -   1 a 10 hombres
    -   Más de 10 hombres
-   Total Mujeres
    -   Ninguna
    -   1 a 10 mujeres
    -   Más de 10 mujeres
-   NÚmero de Socios
    -   Ninguno
    -   Pocos (1 a 4)
    -   Más de 4 socios
-   Hombres Socios
    -   No tiene
    -   Si tiene
-   Hombres Socios
    -   No tiene
    -   Si tiene
-   Contratación por Agencia
    -   Ningún empleado
    -   1 a 10 empleados
    -   Más de 10 empleados.
-   Tipo de Empresa
    -   Comercio de Vehículos
    -   Comercio al por Mayor
    -   Comercio al por Menor

Ilustrativa (por bajo conteo en categorías)
    
-   Tamaño de Empresa
    -   Microempresa
    -   Pequeña
    -   Mediana
    -   Grande
:::


## Agrupamiento Según Tamaño

Ejecutando el software del paquete FactoClass dentro del conjunto de variables tomadas, se nos da lo siguiente:
```{r}

Y = discretas[ , c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 17)]

#numero de grupos
n = 4
fc <- FactoClass(Y, dudi.acm, scanFC = FALSE, nf = 2, nfcl = 10, k.clust = n)


```
El número de ejes retenidos para el análisis factorial son dos, para el agrupamiento son cuatro. Se da la partición en cuatro agrupamientos.

### Tamaño de los Grupos

En la tabla de abajo se pueden revisar el tamaño relativo de cada agrupación:
```{r}
summary ( fc$ cluster ) -> nk

##Tamaños relativos de las clases
round ( nk/ sum ( nk )* 100 ,1)
```

::: {.callout collapse="true"}

## Inercia.
```{r}

barplot(as.vector(fc$dudi$eig), col="darkblue")

```
:::

### Gráfico de Agrupamiento

```{r}
plotFactoClass(fc, x=1, y=2, cex.col=0.5,
               roweti="", infaxes="no", cstar=0)

```

```{r}
#Organizar grupos
n1 = data.frame(n = 1:n)
lista = data.frame(tamaño = (fc$clus.summ$Bef.Size[1:n]), n = (n1))
lista = lista[order(lista$tamaño, decreasing = TRUE), ]
a = data.frame(n = round ( nk/ sum ( nk )* 100 ,1))
a = a[order(a$n, decreasing = TRUE), ]

```


### Descripción de Agrupamientos

#### Grupo 1: Microempresas

Microempresas: Se caracterizan por tener poco personal. Donde la mayoría son a terminó indefinido. No invierten en publicidad, y son empresas con un solo dueño. Se dedican al comercio al por menor y son empresas jóvenes.

:::{.callout collapse="true"}
## Desplegar
```{r}
kable(fc$carac.cate[lista$n[1]])

```
:::


#### Grupo 2: Empresas Consolidadas

Son una combinación entre empresas medianas y pequeñas (65% medianas y 35% pequeñas). Contratan bastante personal a término indefinido, pero no contratan por prestación de servicios. Invierten de manera conservadora en publicidad, y se dedican en su mayoría al sector mayorista. Cabe resaltar que son empresas con cierta experiencia.

:::{.callout collapse="true"}
## Desplegar
```{r}
kable(fc$carac.cate[lista$n[2]])

```
:::

#### Grupo 3: Empresas Pequeñas

Tienen la característica de que solo contratan personal por prestación de servicios. Se dedican al sector minoritario, e invierten poco en publicidad. Tienen la particularidad, de que en su mayoría están conformadas por socios hombres.

:::{.callout collapse="true"}
## Desplegar
```{r}

kable(fc$carac.cate[lista$n[3]])

```
:::

#### Grupo 4: Empresas Grandes

Gran cantidad de empleados. Contratan de todas las formas posibles. Se dedican al sector de vehículos, se conforman por socios y tienen bastante años en la industria. Es importante señalar que la inversión por publicidad es alta.

:::{.callout collapse="true"}
## Desplegar
```{r}

kable(fc$carac.cate[lista$n[4]])

```
:::





## Agrupamiento Según Proyección

Como han podido notar, existe un patrón claro en los datos, lo que nos lleva a preguntarnos si existe otro tipo de clasificación. En este caso, realizamos una clasificación propia para poder comparar los resultados y evaluar cuál es la mejor clasificación posible. Incorporamos una clasificación personalizada.


```{r}
Y = discretas[ , c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)]

n = 5
fc <- FactoClass(Y, dudi.acm, scanFC = FALSE, nf = 2, nfcl = 10, k.clust = n)
##Como han podido notar, existe un patron claro en los datos. Nos hace preguntar si exite ptro tipo de clasificacion
##En este caso, realizamos una clasificaion porpia, para poder comparar los resultados y evaluar la mejor clasificaion posible.
#Incorporamos una clasificacion propia


```
El número de ejes retenidos para el análisis factorial son dos, para el agrupamiento son diez. Se da la partición en cinco agrupamientos.

### Tamaño de los Grupos

En la tabla de abajo se pueden revisar el tamaño relativo de cada agrupación:

```{r}
x = data.frame(fc$dudi$li)


g1 = x[x[1] >1, ]
g2 = x[x[1] >0.67 & x[1] <=1, ]
g3 = x[x[1] >0.235 & x[1] <=0.67, ]
g4 = x[x[1] >-0.146 & x[1] <=0.235, ]
g5 = x[x[1] >-0.5 & x[1] <=-0.146, ]

# Combinar todos los dataframes en uno solo, añadiendo una columna para identificar el grupo
g1$source <- 5
g2$source <- 4
g3$source <- 3
g4$source <- 2
g5$source <- 1

#creamos un vector de tipo factor que contenga las clasificaciones
all_data <- rbind(g1, g2, g3, g4, g5)
all_data$index = as.integer(rownames(all_data))
all_data <- all_data[order(all_data$index), ]
df = all_data[, c(3, 4)]
df = as.factor(df[ ,1])

fc$cluster = df
summary ( fc$ cluster ) -> nk
##Tamaños relativos de las clases
round ( nk/ sum ( nk )* 100 ,1)

```


### Gráfico de Agrupamiento
```{r}

plotFactoClass(fc, x=1, y=2, cex.col=0.5,
               roweti="", infaxes="no", cstar=0)

```

### Descripción de Agrupamientos

#### Grupo 1 Pequeñas y medianas empresas

Reunen aproximadamente el 70% de los datos. Se caracterizan por su gran cantidad de personal temporal. No contratan personal indefinido, invierten en poca publicidad y contratan una gran variedad de aprendices. Se dedican mayoritariamente al sector minoritario.


::: {.callout collapse="true"}
## Desplegar
```{r}
##Grupo 1 (12.5%) Empresas jovenes

kable(fc$carac.cate[1])
```
:::

#### Grupo 2: Microemepresas
 
Tienen la característica de que solo contratan personal por prestación de servicios. Se dedican al sector minoritario, e invierten poco en publicidad. No tienen una edad definida.

::: {.callout collapse="true"}
## Desplegar
```{r}
##Grupo 2 (29.6%) Empresas consolidadas
kable(fc$carac.cate[2])
```
:::


#### Grupo 3: Tiendas consolidadas

Son empresas con un solo dueño, que solo contratan pocas a personas a término indefinido. Tienen bastantes años consolidados en la industria. No invierten en publicidad.


::: {.callout collapse="true"}
## Desplegar
```{r}
##Grupo 3 (11.7%) Empresas "Explotadoras"
kable(fc$carac.cate[3])
```
:::



#### Grupo 4: Empresas Grandes

Tienen bastantes empleados y contratan todo tipo de personal. Se dedican al sector vehículos e invierten moderadamente en publicidad. Son conformadas en su mayoría por socios.


::: {.callout collapse="true"}
## Desplegar
```{r}
##Grupo 4 (15.3%) Tiendas al por Menor
kable(fc$carac.cate[4])
```
:::


#### Grupo 5: Empresas de Alta Rotación de Personal

A pesar de tener mucho personal, solo contratan personal temporal. Estan conformadas por socios, y tienen edades entre 10 y 30 años. Ademas de contratar pocos aprendices.

::: {.callout collapse="true"}
## Desplegar
```{r}
##Grupo 5 (30.8%) Microempresas
kable(fc$carac.cate[5])
```
:::


```{r}
# octavarium GOD
```
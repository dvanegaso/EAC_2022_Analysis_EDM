---
title: "Agrupamiento"
format: html
editor: visual
theme: lux
echo: false
---
```{r}

suppressMessages({
  # cambia idioma de la consola de R a español:
  Sys.setenv(LANG="es")
  
  #Sin notacion cientifica y con 3 decimales
  options(digits = 3, scipen = 999) 
  
  #Importamos Librerias
  library(readxl)
  library(FactoClass)
  library(factoextra)
  library(plotly)
  library(knitr)
  library(ggplot2)
  library(dplyr)
  library(Factoshiny)
  library(DT) # para tablas interactivas
  library(plotly) # para gráficos interactivos
  
  #Importamos la base de datos
  setwd("C:/Users/thetr/OneDrive/Documentos/R/Proyecto EDM")
  ruta_del_archivo <- "EAC_CIFRAS_2022_ANONIMIZADA_FINAL.csv"
  datos_orig <- read.csv(ruta_del_archivo, sep = ";", dec = ",")
  
  #En nuestro estudio, tomaremos aquellas empresas Activas. POr lo que, no tomaremos encienta a empresas con produccion bruta = 0. 
  #Asi que, eliminaremos aquellos datos que tengan produccion bruta =0 (Son alrededor de 200 datos).
  datos <- datos_orig[!is.na(as.numeric(datos_orig$BRUTA)) & as.numeric(datos_orig$BRUTA) != 0, ]
  
#Crearemos dos nuevas bases de datos, en este caso, para las variables discretas y continuas de nuestro interes.
#IDOJ1
discretas <- select(datos, CORRELA_16, IDAIO, PROMUJ, PROHOM, PERMUJ, PERHOM, DIRMUJ, DIRHOM, AGENCIA, APRENDIZ, PUBLICI, SOCIOS, PERSONOM, DIRECTO, TOTMUJ, TOTHOM)
continuas <- select(datos, BRUTA, CONSUI, SUELDOS, PRESTAC, VENTA, AGREGA, SUEPLAN, PREPLAN, COTIZA, TOTREM, ROTACION, INVPRO, CTO, CTOINS, GASTOS, GASTOSNOP)
                                                                    
# convertimos los datos a tipo numerico. 
continuas <- data.frame(lapply(continuas, function(x) as.numeric(as.character(x))))
# convertimos a sus respectivos valores en pesos colombianos
continuas <-1000*continuas

#Ahora agregamos nuevas variables a continuas
Clasifemp <-discretas$CORRELA_16
continuas <- cbind(Clasifemp, continuas)

#asignamos a los NA el valor de cero
continuas[is.na(continuas)] <- 0 

# Ahora, clasificamos los datos de tipo discret

#Años empresa
años <- as.integer(discretas$IDAIO)
años[años < 1972] <- 1
años[años >= 1972 & años < 1982] <- 2
años[años >= 1982 & años < 1992] <- 3
años[años >= 1992 & años < 2002] <- 4
años[años >= 2002 & años < 2012] <- 5
años[años >= 2012 & años < 2024] <- 6

años <- factor(años, labels=c( "Mas de 50","Entre 40 y 50", "Entre 30 y 40", "Entre 30 y 20", "Entre 20 y 10", "Menos de 10"))
discretas$IDAIO <- años
#personal permanete
permanente <- as.integer(discretas$PERSONOM)
permanente [permanente >= 1 & permanente < 10 ] <- 1
permanente [permanente >= 10 ] <- 2
permanente <- factor(permanente, labels=c("(0)PERM", "(1-10)PERM", "(>10)PERM"))
discretas$PERSONOM <- permanente 

# Personal DIRECTO
directo <- as.integer(discretas$DIRECTO)
directo[directo >= 1 & directo<= 10 ] <- 1
directo[directo  > 10 ] <- 2
directo <- factor(directo, labels=c("(0)DIREC", "(1-10)DIREC", "(>10)DIREC"))
discretas$DIRECTO <- directo

#Total hombres
thombres <- as.integer(discretas$TOTHOM)
thombres[is.na(thombres)] <- 0 #Asignarle el valor de cero a los nas
thombres[thombres >= 1 & thombres<= 10 ] <- 1
thombres[thombres  > 10 ] <- 2
thombres <- factor(thombres, labels=c("(0)HOMBRES", "(1-10)HOMBRES", "(>10)HOMBRES"))
discretas$TOTHOM <- thombres


#Total Mujeres
tmujeres <- as.integer(discretas$TOTMUJ)
tmujeres[is.na(tmujeres)] <- 0 #Asignarle el valor de cero a los nas
tmujeres[tmujeres >= 1 & tmujeres < 10 ] <- 1
tmujeres[tmujeres >= 10 ] <- 2
tmujeres <- factor(tmujeres, labels=c("(0)MUJERES", "(1-10)MUJERES", "(>10)MUJERES"))
discretas$TOTMUJ <- tmujeres

# numero de socios
n_socios <- as.numeric(datos$SOCIOS)
n_socios[n_socios == 0 ] <- 0 #Asignarle el valor de cero a los nas
n_socios[n_socios > 0 & n_socios < 4] <- 1
n_socios[n_socios >= 4 & n_socios<100] <- 2
n_socios <- factor(n_socios, labels=c("No Registra","Pocos Socios", "Bastantes Socios"))
discretas$SOCIOS <- n_socios

#clasificamos las empresas segun su tamañó. Es este caso, basaremos la clasificaion "Decreto 957 de 2019".
pbruta <- 1000*as.numeric(datos$BRUTA)
#precio uvt añó 2022
uvt22 = 38004
TMÑEMP <- unlist(pbruta/uvt22)
TMÑEMP[TMÑEMP <= 44769 ] <- 1
TMÑEMP[TMÑEMP > 44769 & TMÑEMP <= 431196] <- 2
TMÑEMP[TMÑEMP > 431196 & TMÑEMP <= 2160692] <- 3
TMÑEMP[TMÑEMP > 2160692] <- 4
TMÑEMP <- factor(TMÑEMP, labels=c("MIcroe", "PQempr", "MEdempr", "EmprGran"))
discretas <- cbind(discretas, TMÑEMP)

#Clasificamos publicidad, basandonos en el porcentaje gastado respecto a la produccion bruta.
pbruta <- abs(pbruta/1000)
publicidad <- as.numeric(discretas$PUBLICI)
contador = as.integer(1)

for(i in publicidad){
  if (i/pbruta[contador] > 0 & i/pbruta[contador] <= 0.05){
    publicidad[contador] <- 1 
  }else if (i/pbruta[contador] > 0.05 & i/pbruta[contador] <= 0.1) {
    publicidad[contador] <- 2 
  }else if (i/pbruta[contador] > 0.1) {
    publicidad[contador] <- 3
  }
  contador <- contador+1
  
}

publicidad <- factor(publicidad, labels=c("Nopub", "Pubbaja", "Pubmod", "Pubalta"))
discretas$PUBLICI <- publicidad

#OTRAS POSIBLES CLASIFICACIONES


# #Socios Mujeres
smujeres <- as.integer(discretas$PROMUJ)
smujeres[smujeres >= 1 ] <- 1
smujeres <- factor(smujeres, labels=c("SisociosM", "NosociosM"))
discretas$PROMUJ<- smujeres
# 
#Socios Hombres
shombres <- as.integer(discretas$PROHOM)
shombres[shombres >= 1 ] <- 1
shombres <- factor(shombres, labels=c("SisociosH", "NosociosH"))
discretas$PROHOM<- shombres

#personal permanete mujeres
pmujeres <- as.integer(discretas$PERMUJ)
pmujeres[pmujeres >= 1 & pmujeres < 10 ] <- 1
pmujeres[pmujeres >= 10 ] <- 2
pmujeres <- factor(pmujeres, labels=c("(0)PerM", "(1-10)PerM", "(>10)PerM"))
discretas$PERMUJ <- pmujeres

# Personal permanente Hombres
phombres <- as.integer(discretas$PERHOM)
phombres[phombres >= 1 & phombres<= 10 ] <- 1
phombres[phombres  > 10 ] <- 2
phombres <- factor(phombres, labels=c("(0)PerH", "(1-10)PerH", "(>10)PerH"))
discretas$PERHOM <- phombres
# 
# Personal Temporal Mujeres
tmujeres <- as.integer(discretas$DIRMUJ)
tmujeres[tmujeres >= 1 & tmujeres < 10 ] <- 1
tmujeres[tmujeres >= 10 ] <- 2
tmujeres <- factor(tmujeres, labels=c("(0)tempM", "(1-10)tempM", "(>10)tempM"))
discretas$DIRMUJ <- tmujeres

# Personal Temporal Hombres
thombres <- as.integer(discretas$DIRHOM)
thombres[thombres >= 1 & thombres<= 10 ] <- 1
thombres[thombres  > 10 ] <- 2
thombres <- factor(thombres, labels=c("(0)tempH", "(1-10)tempH", "(>10)tempH"))
discretas$DIRHOM <- thombres
# 
# Personal temporal cont a través de agencias
ptagenc <- as.integer(discretas$AGENCIA)
ptagenc[ptagenc >= 1 & ptagenc < 10 ] <- 1
ptagenc[ptagenc >= 10 ] <- 2
ptagenc <- factor(ptagenc, labels=c("(0)PTAgenc", "(1-10)PTAgenc", "(>10)PTAgenc"))
discretas$AGENCIA <- ptagenc
# 
# Aprendices
aprendiz <- as.integer(discretas$APRENDIZ)
aprendiz[aprendiz >= 1 & aprendiz<= 10 ] <- 1
aprendiz[aprendiz  > 10 ] <- 2
aprendiz <- factor(aprendiz, labels=c("(0)Apren", "(1-10)Apren", "(>10)Apren"))
discretas$APRENDIZ <- aprendiz





#Reclasificamos al tipo de empresas

# Tipempr <- discretas$CORRELA_16
# tipo1 <- list(454, 451, 453)
# tipo2 <- list(462, 464, 465, 466)
# tipo3 <- list("4711-472", 4719, 473, "4741-4742", 4752, "4759-4761", "4771-4751", 4772, 4773)
# 
# Tipempr[Tipempr %in% tipo1] <- 1
# Tipempr[Tipempr %in% tipo2] <- 2
# Tipempr[Tipempr %in% tipo3] <- 3
# 
# Tipempr <- factor(as.integer(Tipempr), labels=c("Comercio vehiculos", "Comercio al por mayor", "Comercio al por menor"))
# discretas$CORRELA_16 <- Tipempr
# 
# table(discretas$IDOJ1)
# K <- unclass(table(discretas$TMÑEMP, discretas$CORRELA_16))
# K_add <- addmargins(K)

#PCAshiny(continuas)
#res.PCA<-PCA(continuas,quali.sup=c(1),graph=FALSE)
#plot.PCA(res.PCA,choix='var',cex=1.2,cex.main=1.2,cex.axis=1.2 )
#plot.PCA(res.PCA,axes=c(1,3),choix='var')
#plot.PCA(res.PCA,axes=c(2,3),choix='var')
# Semilla
set.seed(13)

#Reclasificamos algunas variables para poder tener categorias uniformes
#Reclasificamos edad

años <- as.integer(datos$IDAIO)
años[años < 1992] <- 1
años[años >= 1992 & años < 2002] <- 2
años[años >= 2002 & años < 2012] <- 3
años[años >= 2012 & años < 2024] <- 4

años <- factor(años, labels=c( "Mas de 30", "Entre 30 y 20", "Entre 20 y 10", "Menos de 10"))
discretas$IDAIO <- años

#Reclasificamos al tipo de empresas

Tipempr <- discretas$CORRELA_16
tipo1 <- list(454, 451, 453)
tipo2 <- list(462, 464, 465, 466)
tipo3 <- list("4711-472", 4719, 473, "4741-4742", 4752, "4759-4761", "4771-4751", 4772, 4773)

Tipempr[Tipempr %in% tipo1] <- 1
Tipempr[Tipempr %in% tipo2] <- 2
Tipempr[Tipempr %in% tipo3] <- 3

Tipempr <- factor(as.integer(Tipempr), labels=c("Comercio vehiculos", "Comercio al por mayor", "Comercio al por menor"))
discretas$CORRELA_16 <- Tipempr
discretas[] <- lapply(discretas, as.factor)

#Variables activas
#Usaremos las mismas variables que en el acm
Y = discretas[, 1:11]
##1. Número de ejes para el ACM: Usaremos 2, esto basandonos en el criterio de benzecri
##2. Número de ejes para la clasicación: Usando el criterio descrito en el libro, optamos por 4
##3 Número de clases: Usaremos nuestro propio criterio basandonos en la proyeccion de los individuos. En este caso, 5 grupos.
fc <- FactoClass(Y, dudi.acm,scanFC = FALSE, nf = 2, nfcl = 4, k.clust = 5)

})
```
## Tabla de Inercia
```{r}
barplot(as.vector(fc$dudi$eig), col="darkblue", main ="Inercia")
##Arbol de corte

```

```{r}


barplot(rev(tail(fc$indices$Indice,15)), horiz=TRUE, col="darkblue")

```

```{r}
summary ( fc$ cluster ) -> nk
```

::: {.callout collapse="true"}
## Tabla Previa
```{r}
kable(fc$ cluster)
```
:::
::: {.callout collapse="true"}
##Tamaños relativos de las clases
```{r}
##Tamaños relativos de las clases
round ( nk/ sum ( nk )* 100 ,1)

```
:::
::: {.callout collapse="true"}

##Tamaños e inercia. Pongalo de relleno :v
```{r}


##Tamaños e inercia. Pongalo de relleno :v
fc$clus.summ[,1:4]

```
:::

##Grafico de clasificacion

```{r}
plotFactoClass(fc, x=1, y=2, cex.col=0.5,
               roweti="", infaxes="no", cstar=0)

```




## Clasificación Alterna

Como han podido notar, existe un patrón claro en los datos, lo que nos lleva a preguntarnos si existe otro tipo de clasificación. En este caso, realizamos una clasificación propia para poder comparar los resultados y evaluar cuál es la mejor clasificación posible. Incorporamos una clasificación personalizada.



```{r}

x = data.frame(fc$dudi$li)

g1 = x[x[1] >1, ]
g2 = x[x[1] >0.67 & x[1] <=1, ]
g3 = x[x[1] >0.235 & x[1] <=0.67, ]
g4 = x[x[1] >-0.146 & x[1] <=0.235, ]
g5 = x[x[1] >-0.5 & x[1] <=-0.146, ]

# Combinar todos los dataframes en uno solo, añadiendo una columna para identificar el grupo
g1$source <- 5
g2$source <- 4
g3$source <- 3
g4$source <- 2
g5$source <- 1

#creamos un vector de tipo factor que contenga las clasificaciones
all_data <- rbind(g1, g2, g3, g4, g5)
all_data$index = as.integer(rownames(all_data))
all_data <- all_data[order(all_data$index), ]
df = all_data[, c(3, 4)]
df = as.factor(df[ ,1])

fc$cluster = df

#Grafico de clasificacion
barplot(as.vector(fc$dudi$eig), col="darkblue")
plotFactoClass(fc, x=1, y=2, cex.col=0.5,
               roweti="", infaxes="no", cstar=0)
```



A pesar de que, en teoría, se observa una mejor clasificación de los datos, en la práctica, el resultado es bastante deficiente.

Observemos el grupo 1:


::: {.callout collapse="true"}
## Desplegar
```{r}
fc$carac.cate[1]
```
:::
Teniendo en cuenta que este grupo equivale al 70% de los individuos, no tiene sentido que esté compuesto en su mayoría por empresas con mucho personal, empresas antiguas y empresas dedicadas al comercio de vehículos. Es decir, la clasificación sugiere que el 70% de las empresas son grandes o medianas, lo cual contradice lo descrito en nuestro análisis descriptivo. Tenemos la hipótesis de que este comportamiento se debe a la influencia de los datos atípicos (empresas grandes).
```{r}
##Teniendo en cuenta que este grupo equivale al 70% de los individuos, no tiene sentido que contenga
##en su mayoria a empresas con bastante personal, empresas antiguas, y empresas dedicadas al comercio de vehiculos
##Es decir, la clasificacion afirma que el 70% de las empresas son gramdes o medianas, lo cual descrito en nuestro analisis descriptivo es una contradiccion
##Tenemos la hipotesis, de que el comportamiento se debe a la influencia de los datos atipicos(Empresas grandes).
# Establecer la semilla


##Descripcion grupos
```
## Descripcion de los Grupos
```{r}
fc <- FactoClass(Y, dudi.acm,scanFC = FALSE, nf = 2, nfcl = 4, k.clust = 5)
```

### Grupo 1 (12.5%) Empresas jovenes
::: {.callout collapse="true"}
## Desplegar
```{r}
##Grupo 1 (12.5%) Empresas jovenes

fc$carac.cate[1]
```
:::

Se caracteriza por no tener personal permanente y tener poco personal temporal. Son empresas muy jóvenes. Tienen una tendencia a contratar más hombres, no invierten en publicidad y se dedican al comercio al por menor.
```{r}

##Se caracteriza por no tener personal permanete, tener poco personal temporal. Empresas muy jovenes.
## Tendencia a contratar mas hombres, no invertir en publicidad y dedicarse al comercio al por menor. 


##Grupo 2 (29.6%) Empresas consolidadas

## Bastante personal a termino indefindo, sin empleados con contrato temporal, publicidad moderada
## Se dedican mayoritariamente al comercio al por mayor y de vehiculos. Son empresas ya consolidadas en el mercado
## Cabe destacar la cantidad de aprendices y que son empresas con sociedades. 
```

### Grupo 2 (29.6%) Empresas consolidadas

::: {.callout collapse="true"}
## Desplegar
```{r}
fc$carac.cate[2]
```
:::

Tienen bastante personal a término indefinido, sin empleados con contrato temporal y con publicidad moderada. Se dedican mayoritariamente al comercio al por mayor y de vehículos. Son empresas ya consolidadas en el mercado. Cabe destacar la cantidad de aprendices y que son empresas con estructuras societarias.


### Grupo 3 (11.7%) Empresas Explotadoras
```{r}
##Grupo 3 (11.7%) Empresas Explotadoras

##Empresas con bastante personal a contrato temporal. Sin personal a termino indefinido. Con bastantes aprendices, y personal contratado por agencia.
## invierten poco en publicidad, tienen bastante tiempo en el mecado y  se dedican al comercio menor. 
```

::: {.callout collapse="true"}
## Desplegar
```{r}
fc$carac.cate[3]
```
:::

Son empresas con bastante personal a contrato temporal y sin personal a término indefinido. Tienen numerosos aprendices y personal contratado a través de agencias. Invierten poco en publicidad, tienen bastante tiempo en el mercado y se dedican al comercio al por menor.


### Grupo 4 (15.3%) Tiendas al por Menor
```{r}
##Grupo 4 (15.3%) # Tiendas al por menor
```

::: {.callout collapse="true"}
## Desplegar
```{r}
fc$carac.cate[4]
```
:::

Empresas sin socios, sin personal temporal y con poco personal a término indefinido. Se dedican al comercio al por menor y no invierten en publicidad.
```{r}
## Empresas sin socios, sin personal temporal y con poco personal a termino indefinido. 
## Se dedican al comercio menor y no invierten en publicidad

##Grupo 5 (30.8%) Microempresas

## Empresas con poco personal permanente, sin personal indefinido. Empresas sin aprendices, con socios .
##No invierten en publicidad, y son empresas muy jovenes
```
## Grupo 5 (30.8%) Microempresas

::: {.callout collapse="true"}
## Desplegar
```{r}
fc$carac.cate[2]
```
:::

Son empresas con poco personal permanente, sin personal indefinido, sin aprendices y con socios. No invierten en publicidad y son empresas muy jóvenes.
```{r}

## Proyeccion grupos ACP
```
## Proyecciones de Grupos
### Con ACP
```{r}
#Reclasificamos las nuevas variables
grupos <- factor(fc$cluster, labels=c( "Jovenes", "Consolidadas","Explotadoras", "Tiendas", "Microempresas"))
#Proyeccion sobre el acp
Z <- continuas[, 2:17]
# inercia usando  ade4 y FactoClass
acp <- dudi.pca(Z, scannf = FALSE, nf = 4)
valp <- t(inertia(acp)$tot.inertia) # valores propios
#variables complementarias(grupos)
Ysupcat <- grupos
#convertimos las variables en fatores
sup <- supqual(acp, Ysupcat)
```

```{r}
## Es evidente que las empresas explotadoras y consolidadas, 
## tiene mejores ingresos. A diferencia de las otros tres grupos que se comportan de manera similar.
## El de resaltar el caso de empresas explotadores, a pesar de lo poca calidad de empleo que ofrecen ,poseen los mayoress ingresos.
```
Es evidente que las empresas explotadoras y consolidadas tienen mejores ingresos, a diferencia de los otros tres grupos que se comportan de manera similar. Cabe resaltar el caso de las empresas explotadoras, que, a pesar de la baja calidad del empleo que ofrecen, poseen los mayores ingresos.
```{r}
#Grafico 1
plot(acp, Tcol = FALSE, ucal = 10, cex.row = 0.00001,
     xlim = c(-1.3, 0.6), ylim = c(-0.6,0.6), col.row = 16)
s.arrow(acp$co[c(1, 2, 3, 5, 12, 16), ], add.plot = TRUE, boxes = FALSE)
#Grupos
points(sup$coor[1:5,], col = 2, pch = 16)
text(sup$coor[1:5,], labels = rownames(sup$coor[1:5,]),
     col = 2, pos = 1, font = 4)
title(main = "Grupos proyectados en acp")


##Proyeccion grupos ACM

acm = MCA(Y, graph=FALSE)
ilustrativas = data.frame(grupos, continuas$BRUTA)

Ys <- cbind(ilustrativas, Y)

res.mca <- MCA(Ys, graph=FALSE, quali.sup = 1, quanti.sup = 2)
```
### Con ACM
```{r}
##Muy poco a resaltar. Es la misma descripcion que se le dio a cada grupo. Solo es una descripcion grafica.
```
Hay muy poco que resaltar. Es la misma descripción que se le dio a cada grupo; solo se trata de una descripción gráfica.
```{r}
fviz_mca_var(res.mca, repel = TRUE, 
             ggtheme= theme_minimal())
```

